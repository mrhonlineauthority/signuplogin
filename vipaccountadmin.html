<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding: 20px; background: #f8f9fa; }
h2 { text-align: center; margin-bottom: 20px; }
.table th, .table td { vertical-align: middle; font-size: 0.9rem; }
.table thead th { background-color: #ff69b4; color: white; }
.action-btns { display: flex; gap: 5px; justify-content: center; }
.btn-sm { width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
.btn-success { background-color: #28a745; border-color: #28a745; }
.btn-warning { background-color: #ffc107; border-color: #ffc107; }
.btn-danger { background-color: #dc3545; border-color: #dc3545; }
.star { cursor:pointer; width:20px; height:20px; margin-right:2px; }
#loginCard { max-width: 400px; margin: 100px auto; padding: 20px; background:white; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.2);}
#adminPanel { display:none; }
.pagination { justify-content: flex-end; }
.id-container { display:flex; align-items:center; justify-content:center; gap:5px; cursor:pointer; }
.id-text { font-weight:bold; }
</style>
</head>
<body>

<!-- Admin Login Card -->
<div id="loginCard">
  <h2>Admin Login</h2>
  <div class="mb-3">
    <label for="email" class="form-label">Email</label>
    <input type="email" class="form-control" id="email" placeholder="Admin Email">
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password</label>
    <input type="password" class="form-control" id="password" placeholder="Password">
  </div>
  <button id="loginBtn" class="btn btn-primary w-100">Login</button>
  <div id="loginError" class="text-danger mt-2"></div>
</div>

<!-- Admin Panel -->
<div id="adminPanel">
<h2>Admin Panel</h2>

<!-- Email Search -->
<div class="mb-3" style="max-width:400px; margin:auto;">
  <input type="text" id="searchEmail" class="form-control" placeholder="Search by Email">
</div>

<div class="table-responsive">
  <table class="table table-bordered table-sm" id="usersTable">
    <thead>
      <tr>
        <th>Signup Time</th> <!-- New Column -->
        <th>Full Name</th>
        <th>Username</th>
        <th>ID No</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Profile Status</th>
        <th>Status</th>
        <th>Action</th>
        <th>Stars</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<nav aria-label="Page navigation">
  <ul class="pagination" id="pagination"></ul>
</nav>
<button id="logoutBtn" class="btn btn-danger mt-3">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCUedI7nd4-qBDBPQQlNReEZmy18BSgGYA",
  authDomain: "useradminservice.firebaseapp.com",
  databaseURL: "https://useradminservice-default-rtdb.firebaseio.com/",
  projectId: "useradminservice",
  storageBucket: "useradminservice.firebasestorage.app",
  messagingSenderId: "767073548166",
  appId: "1:767073548166:web:a3dbfaed202a13d9b75e07"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const loginCard = document.getElementById('loginCard');
const adminPanel = document.getElementById('adminPanel');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginError = document.getElementById('loginError');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const tbody = document.getElementById('usersTable').getElementsByTagName('tbody')[0];
const pagination = document.getElementById('pagination');
const searchInput = document.getElementById('searchEmail');

let allUsers = [];
let currentPage = 1;
const usersPerPage = 10;

const approveSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16"><path d="M13.485 1.929a1 1 0 0 1 1.414 1.414l-9 9a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L5 10.586l8.485-8.657z"/></svg>`;
const deleteSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm2 3h14v12H5V9zm3 2v8h2v-8H8zm4 0v8h2v-8h-2zm4 0v8h2v-8h-2z"/></svg>`;
const addIDSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="green" viewBox="0 0 16 16"><path d="M8 1v14M1 8h14"/></svg>`;
const editIDSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="orange" viewBox="0 0 16 16"><path d="M12.146.854a.5.5 0 0 1 .708 0l2.292 2.292a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10z"/></svg>`;

// Login
loginBtn.onclick = () => {
  loginError.innerText = '';
  const email = emailInput.value;
  const password = passwordInput.value;
  signInWithEmailAndPassword(auth, email, password)
  .then(userCredential => {
    const uid = userCredential.user.uid;
    onValue(ref(db, 'admins/' + uid), snap => {
      if(snap.exists()){
        loginCard.style.display = 'none';
        adminPanel.style.display = 'block';
        loadUsers();
      } else {
        signOut(auth);
        loginError.innerText = 'Not an admin!';
      }
    }, {onlyOnce:true});
  })
  .catch(err => { loginError.innerText = err.message; });
};

// Logout
logoutBtn.onclick = () => {
  signOut(auth).then(() => {
    adminPanel.style.display = 'none';
    loginCard.style.display = 'block';
  });
};

// Auth State
onAuthStateChanged(auth, user => {
  if(user){
    const uid = user.uid;
    onValue(ref(db, 'admins/' + uid), snap => {
      if(snap.exists()){
        loginCard.style.display = 'none';
        adminPanel.style.display = 'block';
        loadUsers();
      } else {
        loginCard.style.display = 'block';
        adminPanel.style.display = 'none';
      }
    }, {onlyOnce:true});
  } else {
    loginCard.style.display = 'block';
    adminPanel.style.display = 'none';
  }
});

// Load users
function loadUsers(){
  onValue(ref(db,'users'), snapshot=>{
    if(!snapshot.exists()){ 
      tbody.innerHTML = '<tr><td colspan="10" class="text-center">No users found</td></tr>';
      return; 
    }
    allUsers = [];
    snapshot.forEach(childSnap=>{
      const user = childSnap.val();
      user.uid = childSnap.key;
      allUsers.push(user);
    });
    renderTable();
    renderPagination();
  });
}

// Render table
function renderTable(){
  tbody.innerHTML='';
  const start = (currentPage-1)*usersPerPage;
  const end = start + usersPerPage;
  let usersToShow = allUsers.slice(start,end);

  const query = searchInput.value.toLowerCase();
  if(query) usersToShow = usersToShow.filter(u=>u.email.toLowerCase().includes(query));

  usersToShow.forEach(user=>{
    const row = tbody.insertRow();

    // 1️⃣ Signup Time Cell
    const timeCell = row.insertCell(0);
    timeCell.innerText = user.signupTime ? new Date(user.signupTime).toLocaleString() : '—';

    // 2️⃣ Full Name Cell
    row.insertCell(1).innerText = user.fullName || '';

    // 3️⃣ Username Cell
    row.insertCell(2).innerText = user.username || '';

    // 4️⃣ ID No Cell
    const idCell = row.insertCell(3);
    idCell.style.textAlign = 'center';
    const idContainer = document.createElement('div');
    idContainer.className='id-container';

    const idText = document.createElement('span');
    idText.className='id-text';
    idText.innerText = user.idNo || '';
    idContainer.appendChild(idText);

    const idIcon = document.createElement('span');
    idIcon.innerHTML = user.idNo ? editIDSVG : addIDSVG;
    idContainer.appendChild(idIcon);

    idContainer.onclick = ()=>{
      const newId = prompt("Enter 16-digit ID No:", user.idNo||"");
      if(newId && newId.length===16){
        update(ref(db,'users/'+user.uid), {idNo:newId}).then(()=>{
          user.idNo=newId;
          idText.innerText=newId;
          idIcon.innerHTML = editIDSVG;
        });
      } else if(newId) alert('ID must be 16 digits');
    };
    idCell.appendChild(idContainer);

    // 5️⃣ Phone Cell
    row.insertCell(4).innerText = user.phone || '';

    // 6️⃣ Email Cell
    row.insertCell(5).innerText = user.email || '';

    // 7️⃣ Profile Status
    const profileCell = row.insertCell(6);
    const select = document.createElement('select');
    select.className='form-select form-select-sm';
    ['New','Professional','Verify','Vip'].forEach(opt=>{
      const option=document.createElement('option');
      option.value=opt;
      option.text=opt;
      if(user.profileStatus===opt) option.selected=true;
      select.appendChild(option);
    });
    select.onchange = ()=>update(ref(db,'users/'+user.uid),{profileStatus:select.value});
    profileCell.appendChild(select);

    // 8️⃣ Status Cell
    const statusCell=row.insertCell(7);
    statusCell.innerText = user.status || 'pending';

    // 9️⃣ Action Cell
    const actionCell=row.insertCell(8);
    const actionDiv=document.createElement('div');
    actionDiv.className='action-btns';

    const approveBtn=document.createElement('button');
    approveBtn.className=user.status==='approved'?'btn btn-warning btn-sm':'btn btn-success btn-sm';
    approveBtn.innerHTML=approveSVG;
    approveBtn.title=user.status==='approved'?'Unapprove':'Approve';
    approveBtn.onclick=()=>{
      const newStatus = approveBtn.title==='Approve'?'approved':'pending';
      update(ref(db,'users/'+user.uid),{status:newStatus});
    };
    actionDiv.appendChild(approveBtn);

    const deleteBtn=document.createElement('button');
    deleteBtn.className='btn btn-danger btn-sm';
    deleteBtn.innerHTML=deleteSVG;
    deleteBtn.onclick=()=>{ if(confirm(`Delete ${user.fullName}?`)) remove(ref(db,'users/'+user.uid)); };
    actionDiv.appendChild(deleteBtn);
    actionCell.appendChild(actionDiv);

    // 10️⃣ Stars Cell
    const starsCell=row.insertCell(9);
    starsCell.id='stars-'+user.uid;
    for(let i=1;i<=3;i++){
      const star=document.createElementNS("http://www.w3.org/2000/svg",'svg');
      star.setAttribute('xmlns','http://www.w3.org/2000/svg');
      star.setAttribute('viewBox','0 0 24 24');
      star.setAttribute('width','20');
      star.setAttribute('height','20');
      star.classList.add('star');
      star.dataset.uid=user.uid;
      star.dataset.value=i;
      star.innerHTML=`<path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.782 1.4 8.17L12 18.896l-7.334 3.866 1.4-8.17-5.934-5.782 8.2-1.192z" fill="${i<=(user.rating||0)?'gold':'gray'}"/>`;
      star.onclick=()=>{
        update(ref(db,'users/'+user.uid),{rating:i});
        for(let j=1;j<=3;j++){
          starsCell.children[j-1].querySelector('path').setAttribute('fill', j<=i?'gold':'gray');
        }
      };
      starsCell.appendChild(star);
    }
  });
}

// Pagination
function renderPagination(){
  pagination.innerHTML='';
  const totalPages=Math.ceil(allUsers.length/usersPerPage);
  if(totalPages<=1) return;
  const maxButtons=5;
  let startPage=Math.max(1,currentPage-Math.floor(maxButtons/2));
  let endPage=Math.min(totalPages,startPage+maxButtons-1);
  if(endPage-startPage<maxButtons-1) startPage=Math.max(1,endPage-maxButtons+1);

  if(startPage>1){
    const li=document.createElement('li');
    li.className='page-item';
    li.innerHTML=`<a class="page-link" href="#">1 ...</a>`;
    li.onclick=()=>{currentPage=1; renderTable(); renderPagination();};
    pagination.appendChild(li);
  }

  for(let i=startPage;i<=endPage;i++){
    const li=document.createElement('li');
    li.className='page-item'+(i===currentPage?' active':'');
    li.innerHTML=`<a class="page-link" href="#">${i}</a>`;
    li.onclick=()=>{currentPage=i; renderTable(); renderPagination();};
    pagination.appendChild(li);
  }

  if(endPage<totalPages){
    const li=document.createElement('li');
    li.className='page-item';
    li.innerHTML=`<a class="page-link" href="#">... ${totalPages}</a>`;
    li.onclick=()=>{currentPage=totalPages; renderTable(); renderPagination();};
    pagination.appendChild(li);
  }
}

// Search input listener
searchInput.addEventListener('input', () => {
  currentPage=1;
  renderTable();
  renderPagination();
});
</script>
</body>
</html>
