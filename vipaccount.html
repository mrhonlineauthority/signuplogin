<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Panel</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding: 20px; background: #f8f9fa; }
.container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0px 0px 10px #aaa; position: relative;}
h2 { text-align: center; margin-bottom: 20px; }
.hidden { display: none; }
.text-link { color: blue; cursor: pointer; text-decoration: underline; }
#profileIcon { display: block; margin: 10px auto 20px; width: 80px; height: 80px; }

.table { width: 100%; margin-bottom: 0; font-size: 0.9rem; }
.table td, .table th { padding: 0.35rem; vertical-align: middle; }
.editBtn { margin-left: 5px; font-size: 0.75rem; padding: 0.25rem 0.4rem; }

input.form-control-sm { height: calc(1.5em + 0.5rem + 2px); padding: 0.25rem 0.5rem; font-size: 0.85rem; }

.password-wrapper { position: relative; }
.password-wrapper svg { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width:20px; height:20px; cursor:pointer; }

#passwordRules { font-size:12px; color:#555; margin-bottom:8px; }
#passwordRules ul { margin:4px 0 0 16px; padding:0; }

#profileStars svg { margin: 0 2px; }

/* Loader CSS */
.loader {
  border: 2px solid #f3f3f3; 
  border-top: 2px solid #fff; 
  border-radius: 50%;
  width: 18px;
  height: 18px;
  animation: spin 0.8s linear infinite;
  display: inline-block;
  vertical-align: middle;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>

<!-- Signup -->
<div class="container" id="signupDiv">
  <h2>Signup</h2>
  <input type="text" id="fullName" class="form-control mb-2" placeholder="Full Name">
  <input type="text" id="username" class="form-control mb-2" placeholder="Username">
  <input type="text" id="phone" class="form-control mb-2" placeholder="Phone">
  <input type="email" id="email" class="form-control mb-2" placeholder="Email">
  
  <div class="password-wrapper mb-2">
    <input type="password" id="password" class="form-control" placeholder="Password">
    <svg id="toggleSignupPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path id="signupEye" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      <path id="signupEyeOutline" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z"/>
      <line id="signupSlash" x1="3" y1="3" x2="21" y2="21" stroke="currentColor" stroke-width="2" style="display:none"/>
    </svg>
  </div>

  <div id="passwordRules">
    Password must contain:
    <ul>
      <li>At least 8 characters</li>
      <li>1 uppercase letter (A-Z)</li>
      <li>1 lowercase letter (a-z)</li>
      <li>1 number (0-9)</li>
      <li>1 special character (@$!%*?&)</li>
    </ul>
  </div>

  <button class="btn btn-primary w-100" id="signupBtn">Signup</button>
  <p class="text-center mt-2">Already have an account? <span class="text-link" id="showLoginLink">Login here</span></p>
</div>

<!-- Login -->
<div class="container hidden" id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
  
  <div class="password-wrapper mb-2">
    <input type="password" id="loginPass" class="form-control" placeholder="Password">
    <svg id="toggleLoginPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path id="loginEye" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      <path id="loginEyeOutline" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z"/>
      <line id="loginSlash" x1="3" y1="3" x2="21" y2="21" stroke="currentColor" stroke-width="2" style="display:none"/>
    </svg>
  </div>
  
  <button class="btn btn-success w-100" id="loginBtn">Login</button>
  <p class="text-center mt-2">Don't have an account? <span class="text-link" id="backSignupLink">Sign Up</span></p>
</div>

<!-- Profile -->
<div class="container mt-4 hidden" id="profileDiv">
  <h2>Profile</h2>

  <!-- Rating Stars -->
  <div id="profileStars" style="text-align:center; margin-bottom:15px;">
    <svg class="star" data-value="1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="gray" viewBox="0 0 24 24">
      <path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.782 1.4 8.17L12 18.896l-7.334 3.866 1.4-8.17-5.934-5.782 8.2-1.192z"/>
    </svg>
    <svg class="star" data-value="2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="gray" viewBox="0 0 24 24">
      <path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.782 1.4 8.17L12 18.896l-7.334 3.866 1.4-8.17-5.934-5.782 8.2-1.192z"/>
    </svg>
    <svg class="star" data-value="3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="gray" viewBox="0 0 24 24">
      <path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.782 1.4 8.17L12 18.896l-7.334 3.866 1.4-8.17-5.934-5.782 8.2-1.192z"/>
    </svg>
  </div>

  <svg id="profileIcon" xmlns="http://www.w3.org/2000/svg" fill="gray" viewBox="0 0 24 24">
    <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.2c-3.1 0-9.3 1.6-9.3 4.9v2.4h18.6v-2.4c0-3.3-6.2-4.9-9.3-4.9z"/>
  </svg>

  <div style="overflow-x:auto;">
    <table class="table table-bordered table-sm mb-3">
      <tbody>
        <tr>
          <th style="width:25%;">Full Name</th>
          <td id="tdFullName"></td>
          <td style="width:15%;"><button class="btn btn-sm btn-primary editBtn" data-field="fullName">Edit</button></td>
        </tr>
        <tr>
          <th>Username</th>
          <td id="tdUsername"></td>
          <td><button class="btn btn-sm btn-primary editBtn" data-field="username">Edit</button></td>
        </tr>
        <tr>
          <th>Phone</th>
          <td id="tdPhone"></td>
          <td><button class="btn btn-sm btn-primary editBtn" data-field="phone">Edit</button></td>
        </tr>
        <tr>
          <th>Email</th>
          <td id="tdEmail"></td>
          <td>—</td>
        </tr>
        <tr>
          <th>Profile Status</th>
          <td id="tdProfileStatus"></td>
          <td>—</td>
        </tr>
      </tbody>
    </table>
  </div>

  <button class="btn btn-danger w-100" id="logoutBtn">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCUedI7nd4-qBDBPQQlNReEZmy18BSgGYA",
  authDomain: "useradminservice.firebaseapp.com",
  databaseURL: "https://useradminservice-default-rtdb.firebaseio.com/",
  projectId: "useradminservice",
  storageBucket: "useradminservice.firebasestorage.app",
  messagingSenderId: "767073548166",
  appId: "1:767073548166:web:a3dbfaed202a13d9b75e07"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const signupDiv = document.getElementById('signupDiv');
const loginDiv = document.getElementById('loginDiv');
const profileDiv = document.getElementById('profileDiv');

const signupBtn = document.getElementById('signupBtn');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const showLoginLink = document.getElementById('showLoginLink');
const backSignupLink = document.getElementById('backSignupLink');

const tdFullName = document.getElementById('tdFullName');
const tdUsername = document.getElementById('tdUsername');
const tdPhone = document.getElementById('tdPhone');
const tdEmail = document.getElementById('tdEmail');
const tdProfileStatus = document.getElementById('tdProfileStatus');

showLoginLink.addEventListener('click', () => { signupDiv.classList.add('hidden'); loginDiv.classList.remove('hidden'); });
backSignupLink.addEventListener('click', () => { loginDiv.classList.add('hidden'); signupDiv.classList.remove('hidden'); });

function showLoader(button){ button.disabled=true; button.dataset.originalText=button.innerHTML; button.innerHTML='<span class="loader"></span>'; }
function hideLoader(button){ button.disabled=false; button.innerHTML=button.dataset.originalText; }

signupBtn.addEventListener('click', () => {
  const fullName = document.getElementById('fullName').value.trim();
  const username = document.getElementById('username').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  if(!fullName || !username || !phone || !email || !password){ alert("Please fill in all required fields."); return; }

  const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/;
  if(!strongPasswordRegex.test(password)){ alert("Password is not strong enough."); return; }

  showLoader(signupBtn);

  createUserWithEmailAndPassword(auth,email,password).then(userCredential=>{
    const uid=userCredential.user.uid;
    set(ref(db,'users/'+uid),{fullName,username,phone,email,status:'pending',rating:0,profileStatus:'New'}).then(()=>{
      alert('Signup successful! Wait for admin approval.');
      hideLoader(signupBtn);
    });
  }).catch(error=>{ alert(error.message); hideLoader(signupBtn); });
});

loginBtn.addEventListener('click', ()=>{
  const email=document.getElementById('loginEmail').value;
  const password=document.getElementById('loginPass').value;
  showLoader(loginBtn);
  signInWithEmailAndPassword(auth,email,password).then(userCredential=>{
    const uid=userCredential.user.uid;
    get(ref(db,'users/'+uid)).then(snapshot=>{
      if(snapshot.exists() && snapshot.val().status==='approved'){
        const user=snapshot.val();
        tdFullName.innerText=user.fullName;
        tdUsername.innerText=user.username;
        tdPhone.innerText=user.phone;
        tdEmail.innerText=user.email;
        tdProfileStatus.innerText=user.profileStatus || 'New';
        profileDiv.dataset.uid=uid;
        profileDiv.classList.remove('hidden');
        loginDiv.classList.add('hidden');
        updateProfileStars(user.rating || 0);
        hideLoader(loginBtn);
      }else{ alert('Admin has not approved your account yet.'); signOut(auth); hideLoader(loginBtn); }
    });
  }).catch(error=>{ alert(error.message); hideLoader(loginBtn); });
});

logoutBtn.addEventListener('click', ()=>{
  signOut(auth).then(()=>{ profileDiv.classList.add('hidden'); signupDiv.classList.remove('hidden'); });
});

// Edit buttons
document.querySelectorAll('.editBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const field=btn.dataset.field;
    const td=document.getElementById('td'+field.charAt(0).toUpperCase()+field.slice(1));
    if(btn.innerText==='Edit'){
      const input=document.createElement('input');
      input.type='text'; input.value=td.innerText; input.className='form-control form-control-sm';
      td.innerHTML=''; td.appendChild(input); btn.innerText='Save';
    }else{
      const input=td.querySelector('input'); const newValue=input.value;
      const uid=profileDiv.dataset.uid; const updateData={}; updateData[field]=newValue;
      update(ref(db,'users/'+uid),updateData).then(()=>{ td.innerText=newValue; btn.innerText='Edit'; });
    }
  });
});

// Password toggle
document.getElementById('toggleSignupPassword').addEventListener('click',()=>{
  const pwd=document.getElementById('password'); pwd.type=pwd.type==='password'?'text':'password';
  document.getElementById('signupSlash').style.display=pwd.type==='text'?'block':'none';
});
document.getElementById('toggleLoginPassword').addEventListener('click',()=>{
  const pwd=document.getElementById('loginPass'); pwd.type=pwd.type==='password'?'text':'password';
  document.getElementById('loginSlash').style.display=pwd.type==='text'?'block':'none';
});

// Rating stars
const profileStars=document.querySelectorAll('#profileStars .star');
function updateProfileStars(rating){
  profileStars.forEach(star=>{ star.setAttribute('fill',parseInt(star.dataset.value)<=rating?'gold':'gray'); });
}
</script>

</body>
</html>
