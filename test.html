<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{
  background:#f8f9fa;
}

/* ===== LOGIN CARD ===== */
#loginCard{
  max-width:400px;
  margin:100px auto;
  padding:25px;
  background:white;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.1);
  text-align:center;
}

/* ===== LOGO STYLE ===== */
.login-logo{
  width:85px;          /* ছোট */
  height:85px;
  border-radius:50%;   /* গোল */
  object-fit:contain;  /* লেখা কাটবে না */
  margin-bottom:12px;
}

/* ===== TABLE ===== */
.table thead th{
  background:#ff69b4;
  color:#fff;
}

#adminPanel{
  display:none;
  padding:20px;
}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginCard">
  <!-- LOGO -->
  <img src="logo.png" class="login-logo" alt="MRH Logo">

  <h4 class="mb-3">Admin Login</h4>

  <input type="email" id="email" class="form-control mb-2" placeholder="Email">
  <input type="password" id="password" class="form-control mb-2" placeholder="Password">

  <button id="loginBtn" class="btn btn-primary w-100">Login</button>
  <div id="loginError" class="text-danger mt-2"></div>
</div>

<!-- ================= ADMIN PANEL ================= -->
<div id="adminPanel">
  <h3 class="text-center mb-3">Admin Panel</h3>

  <input type="text" id="searchEmail" class="form-control mb-3"
         placeholder="Search by Email"
         style="max-width:400px;margin:auto;">

  <div class="table-responsive">
    <table class="table table-bordered table-sm" id="usersTable">
      <thead>
        <tr>
          <th>Signup Time</th>
          <th>Full Name</th>
          <th>Username</th>
          <th>ID No</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Profile Status</th>
          <th>Status</th>
          <th>Stars</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="text-end mt-3">
    <button id="downloadPdfBtn" class="btn btn-success">Download PDF</button>
    <button id="logoutBtn" class="btn btn-danger">Logout</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCUedI7nd4-qBDBPQQlNReEZmy18BSgGYA",
  authDomain: "useradminservice.firebaseapp.com",
  databaseURL: "https://useradminservice-default-rtdb.firebaseio.com/",
  projectId: "useradminservice",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const tbody = document.querySelector("#usersTable tbody");
let allUsers = [];

/* ===== LOGIN ===== */
loginBtn.onclick = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
  .then(res=>{
    onValue(ref(db,"admins/"+res.user.uid),snap=>{
      if(snap.exists()){
        loginCard.style.display="none";
        adminPanel.style.display="block";
        loadUsers();
      }else{
        signOut(auth);
        loginError.innerText="Not an admin";
      }
    },{onlyOnce:true});
  })
  .catch(e=>loginError.innerText=e.message);
};

logoutBtn.onclick = ()=>{
  signOut(auth).then(()=>{
    adminPanel.style.display="none";
    loginCard.style.display="block";
  });
};

/* ===== LOAD USERS ===== */
function loadUsers(){
  onValue(ref(db,"users"),snap=>{
    allUsers=[];
    tbody.innerHTML="";
    snap.forEach(s=>{
      const u=s.val();
      allUsers.push(u);
    });

    allUsers.forEach(u=>{
      const r=tbody.insertRow();
      r.insertCell().innerText=u.signupTime ? new Date(u.signupTime).toLocaleString() : "";
      r.insertCell().innerText=u.fullName||"";
      r.insertCell().innerText=u.username||"";
      r.insertCell().innerText=u.idNo||"";
      r.insertCell().innerText=u.phone||"";
      r.insertCell().innerText=u.email||"";
      r.insertCell().innerText=u.profileStatus||"";
      r.insertCell().innerText=u.status||"";
      r.insertCell().innerText=u.rating||0;
    });
  });
}
</script>

</body>
</html>
